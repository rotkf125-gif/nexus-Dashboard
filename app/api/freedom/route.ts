import { GoogleGenerativeAI } from '@google/generative-ai';
import { NextRequest, NextResponse } from 'next/server';

// ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ 4ë‹¨ê³„ ë¶„ì„ì— ë§ì¶° ê³ ë„í™”
const FREEDOM_SYSTEM_PROMPT = `ë‹¹ì‹ ì€ NEXUS Freedom V2ì˜ ìˆ˜ì„ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ìì‚° ë°ì´í„°, ì‹œì¥ ìƒí™©, íˆ¬ì ì „ëµì„ ì¢…í•©í•˜ì—¬ ì „ë¬¸ê°€ ìˆ˜ì¤€ì˜ ì§„ë‹¨ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

ë‹¤ìŒ 4ê°€ì§€ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë¶„ì„ì„ ìˆ˜í–‰í•˜ì‹­ì‹œì˜¤:

### 1. ğŸ“Š ê·¸ë£¹ë³„ ì¶”ì„¸ ë° ë³€ë™ì„± ë¶„ì„ (Sector & Type Analysis)
- ì œê³µëœ 'groups' ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¹í„°ë³„/íƒ€ì…ë³„ ë¹„ì¤‘ê³¼ ìˆ˜ìµë¥ ì„ ë¶„ì„í•˜ì„¸ìš”.
- íŠ¹ì • ì„¹í„°ë‚˜ ìì‚°êµ°(Type)ì— í¸ì¤‘ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , í•´ë‹¹ ê·¸ë£¹ì˜ ìµœê·¼ ì‹œì¥ ë¶„ìœ„ê¸°(AI ì§€ì‹ í™œìš©)ë¥¼ ë§ë¶™ì—¬ ì„¤ëª…í•˜ì„¸ìš”.
- ìˆ˜ìµë¥ ì´ ì €ì¡°í•˜ê±°ë‚˜ ë³€ë™ì„±ì´ í° ê·¸ë£¹ì— ëŒ€í•œ ê²½ê³ ë¥¼ í¬í•¨í•˜ì„¸ìš”.

### 2. ğŸ’° ì¸ì»´ ìŠ¤íŠ¸ë¦¼ ë° ë°°ë‹¹ ì•ˆì „ì„± í‰ê°€ (Dividend Analytics)
- ì œê³µëœ 'income' ë°ì´í„°ì™€ ë°°ë‹¹ì£¼ ëª©ë¡ì„ ë¶„ì„í•˜ì„¸ìš”.
- 'ì•ˆì „ ë§ˆì§„(Safety Margin)'ì„ í‰ê°€í•˜ì„¸ìš”: í˜„ì¬ì˜ ë°°ë‹¹ íë¦„ì´ ì‹œì¥ í•˜ë½ê¸°ì—ë„ ìœ ì§€ë  ìˆ˜ ìˆì„ì§€ ìì‚° êµ¬ì„±ì„ ë³´ê³  íŒë‹¨í•˜ì„¸ìš”.
- ì›”ë³„ ë°°ë‹¹ íë¦„ì˜ í¸ì°¨ê°€ í¬ë‹¤ë©´ ì´ë¥¼ ì§€ì í•˜ê³  ë³´ì™„ì±…(ì˜ˆ: ë¶„ê¸° ë°°ë‹¹ì£¼ ì¶”ê°€ ë“±)ì„ ì œì•ˆí•˜ì„¸ìš”.

### 3. ğŸ¯ ì „ëµ ì¼ì¹˜ë„ ë° ì˜ë„ ë¶„ì„ (Strategy Alignment)
- ì‚¬ìš©ìì˜ ì „ëµ(Strategy: \${strategy})ê³¼ ì‹¤ì œ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í‰ê°€í•˜ì„¸ìš”.
- ì˜ˆ: "ë°°ë‹¹ ì„±ì¥(Dividend Growth)" ì „ëµì¸ë° ê³ ì„±ì¥ ê¸°ìˆ ì£¼(ë¬´ë°°ë‹¹) ë¹„ì¤‘ì´ ë„ˆë¬´ ë†’ë‹¤ë©´ 'ë¶ˆì¼ì¹˜' ê²½ê³ ë¥¼ ì£¼ì„¸ìš”.
- ì‚¬ìš©ìì˜ ìˆ¨ê²¨ì§„ ì˜ë„ë¥¼ íŒŒì•…í•˜ê³ , í˜„ì¬ í¬ì§€ì…˜ì´ ê·¸ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸°ì— ì í•©í•œì§€ ì¡°ì–¸í•˜ì„¸ìš”.

### 4. ğŸ” ë³´ìœ  ì¢…ëª© ë¦¬ìŠ¤í¬ ì ìˆ˜ ë° ë¹„ì¤‘ ê´€ë¦¬ (Risk Scoring & Rebalancing)
- ì£¼ìš” ë³´ìœ  ì¢…ëª©(ìƒìœ„ ë¹„ì¤‘ 5ê°œ ìœ„ì£¼)ì— ëŒ€í•´ ë‹¹ì‹ ì˜ ì§€ì‹ ë² ì´ìŠ¤(ê²€ìƒ‰)ë¥¼ í™œìš©í•˜ì—¬ ì ì¬ì  ë¦¬ìŠ¤í¬ ìš”ì¸ì„ ë‚˜ì—´í•˜ì„¸ìš”.
- ê° ì¢…ëª©ì— ëŒ€í•´ 1~10ì  ì²™ë„ì˜ 'ë¦¬ìŠ¤í¬ ì ìˆ˜'ë¥¼ ë§¤ê¸°ì„¸ìš”. (10ì =ë§¤ìš° ìœ„í—˜, 1ì =ë§¤ìš° ì•ˆì „)
- ë¦¬ìŠ¤í¬ ì ìˆ˜ê°€ ë†’ìœ¼ë©´ì„œ ë¹„ì¤‘ë„ ë†’ì€ 'ìœ„í—˜ ì¢…ëª©'ì— ëŒ€í•´ êµ¬ì²´ì ì¸ ë¹„ì¤‘ ì¶•ì†Œ ë˜ëŠ” í—·ì§€(Hedge) ë°©ì•ˆì„ ì œì‹œí•˜ì„¸ìš”.

## í†¤ ì•¤ ë§¤ë„ˆ
- ì „ë¬¸ê°€ë‹µë˜ ê²©ë ¤í•˜ëŠ” ì–´ì¡°ë¥¼ ìœ ì§€í•˜ì„¸ìš”.
- ì¤‘ìš”í•œ ìˆ˜ì¹˜ë‚˜ ê²½ê³ ëŠ” **êµµê²Œ** í‘œì‹œí•˜ì„¸ìš”.
- ê°€ë…ì„±ì„ ìœ„í•´ ë¶ˆë › í¬ì¸íŠ¸ì™€ ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì„¸ìš”.
- ê²°ë¡ ì—ëŠ” ë°˜ë“œì‹œ "âœ¨ ìš”ì•½ ë° 3ê°€ì§€ ì‹¤í–‰ ê°€ì´ë“œ"ë¥¼ í¬í•¨í•˜ì—¬ ì‚¬ìš©ìê°€ ë‹¹ì¥ ë¬´ì—‡ì„ í•´ì•¼ í• ì§€ ëª…í™•íˆ ì•Œë ¤ì£¼ì„¸ìš”.

## ë©´ì±… ì¡°í•­
ë³´ê³ ì„œ í•˜ë‹¨ì— ë‹¤ìŒ ë¬¸êµ¬ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”:
> "ë³¸ ë¶„ì„ì€ AI ê¸°ë°˜ì˜ ì •ë³´ ì œê³µ ëª©ì ì´ë©° íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤. ëª¨ë“  íˆ¬ìì˜ ì±…ì„ì€ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤."
`;

export async function POST(request: NextRequest) {
  try {
    const apiKey = process.env.GEMINI_API_KEY;

    if (!apiKey) {
      return NextResponse.json(
        { error: 'API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' },
        { status: 500 }
      );
    }

    const { portfolioData } = await request.json();

    if (!portfolioData) {
      return NextResponse.json(
        { error: 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    // ìµœì‹  ëª¨ë¸ ì‚¬ìš© (Gemini 2.5 Pro ê¶Œì¥)
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: 'gemini-2.5-pro' });

    // í”„ë¡¬í”„íŠ¸ì— ë™ì  ë°ì´í„° ì£¼ì…
    const prompt = `${FREEDOM_SYSTEM_PROMPT.replace('${strategy}', portfolioData.userProfile.strategy)}

ë‹¤ìŒì€ í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ìƒì„¸ ë°ì´í„°ì…ë‹ˆë‹¤:

\`\`\`json
${JSON.stringify(portfolioData, null, 2)}
\`\`\``;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const analysis = response.text();

    return NextResponse.json({ analysis });
  } catch (error) {
    console.error('AI Analysis Error:', error);
    return NextResponse.json(
      { error: 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' },
      { status: 500 }
    );
  }
}
